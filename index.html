<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snake</title>
    <style>
        #game-board {
            background-color: #ccc;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .snake-part {
            position: absolute;
            background-color: #000;
        }

        .food {
            position: absolute;
            height: 100px;
            width: 100px;
            background-color: blue;
        }
    </style>
</head>

<body>
    <div id="game-board"></div>

    <script>
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);

        const game = {
            gameBoard: $("#game-board"),
            gameBoardSize: { height: 12, width: 20 },
            snake: [
                { x: 20, y: 0 },
                { x: 10, y: 0 },
                { x: 0, y: 0 },
            ],
            snakeWidth: 10,
            snakeLength: 3,
            currentDirection: "",
            commandsList: ["right"],
            commandsListLength: 1,
            boxMode: false,
            interval: 200,

            start() {
                this.drawGameBoard();
                this.drawSnake();
                setInterval(() => {
                    this.handleSnakeControl();
                    this.moveSnake();
                }, this.interval);
            },

            drawGameBoard() {
                Object.assign(this.gameBoard.style, {
                    height: `${this.gameBoardSize.height * this.snakeWidth}px`,
                    width: `${this.gameBoardSize.width * this.snakeWidth}px`,
                });
                this.renderFood();
            },

            renderFood() {
                this.gameBoard.innerHTML += '<div class="food"></div>';
                foodPosition = this.newFoodPosition();
                Object.assign($(".food").style, {
                    width: `${this.snakeWidth}px`,
                    height: `${this.snakeWidth}px`,
                    top: `${foodPosition.y}px`,
                    left: `${foodPosition.x}px`,
                });
            },

            newFoodPosition() {
                let foodX, foodY;
                do {
                    if (
                        this.snakeLength >=
                        this.gameBoardSize.height * this.gameBoardSize.width
                    ) {
                        this.end();
                        break;
                    }
                    foodX =
                        (Math.random() * (this.gameBoardSize.width - 1)).toFixed() *
                        this.snakeWidth;
                    foodY =
                        (Math.random() * (this.gameBoardSize.height - 1)).toFixed() *
                        this.snakeWidth;
                } while (!this.isLegitFoodPosition(foodX, foodY));
                return {
                    x: foodX,
                    y: foodY,
                };
            },

            isLegitFoodPosition(foodX, foodY) {
                let check = true;
                this.snake.forEach((snakePart) => {
                    if (foodX === snakePart.x && foodY === snakePart.y) {
                        check = false;
                    }
                });
                return check;
            },

            drawSnake() {
                // Clear game board
                const oldSnakePart = $$("#game-board > :not(.food)");
                for (let i = 0; i < oldSnakePart.length; i++) {
                    oldSnakePart[i].remove();
                }

                //Draw
                this.snake.forEach((element, index) => {
                    this.gameBoard.innerHTML += `<div class="snake-part id-${index}"></div>`;
                    const snakePart = $(`.snake-part.id-${index}`);
                    Object.assign(snakePart.style, {
                        width: `${this.snakeWidth}px`,
                        height: `${this.snakeWidth}px`,
                        top: `${element.y}px`,
                        left: `${element.x}px`,
                    });
                });
            },

            moveSnake() {
                this.advanceHead();
                this.handleCollision();
                this.snake.pop();

                this.drawSnake();

                if (this.isFoodEaten()) {
                    this.advanceHead();
                    this.snakeLength++;

                    const newFoodPos = this.newFoodPosition();
                    Object.assign($(".food").style, {
                        top: newFoodPos.y + "px",
                        left: newFoodPos.x + "px",
                    });
                }
            },

            handleCollision() {
                const collidingStatus = this.isCollided();
                switch (collidingStatus) {
                    case 1:
                        this.end();
                        break;
                    case 2:
                        if (this.boxMode) {
                            this.end();
                        } else {
                            const snakeHead = this.snake[0];
                            if (snakeHead.x >= this.gameBoardSize.width * this.snakeWidth) {
                                snakeHead.x = 0;
                            } else if (
                                snakeHead.y >=
                                this.gameBoardSize.height * this.snakeWidth
                            ) {
                                snakeHead.y = 0;
                            } else if (snakeHead.x < 0) {
                                snakeHead.x = (this.gameBoardSize.width - 1) * this.snakeWidth;
                            } else if (snakeHead.y < 0) {
                                snakeHead.y = (this.gameBoardSize.height - 1) * this.snakeWidth;
                            }
                        }
                        break;
                }
            },

            advanceHead() {
                const snakeHead = this.snake[0];
                switch (this.currentDirection) {
                    case "up":
                        this.snake = [
                            { x: snakeHead.x, y: snakeHead.y - this.snakeWidth },
                            ...this.snake,
                        ];
                        break;
                    case "right":
                        this.snake = [
                            { x: snakeHead.x + this.snakeWidth, y: snakeHead.y },
                            ...this.snake,
                        ];
                        break;
                    case "down":
                        this.snake = [
                            { x: snakeHead.x, y: snakeHead.y + this.snakeWidth },
                            ...this.snake,
                        ];
                        break;
                    default:
                        this.snake = [
                            { x: snakeHead.x - this.snakeWidth, y: snakeHead.y },
                            ...this.snake,
                        ];
                        break;
                }
            },

            isFoodEaten() {
                if (
                    $(".food").style.top === $(".snake-part.id-0").style.top &&
                    $(".food").style.left === $(".snake-part.id-0").style.left
                ) {
                    return true;
                }
                return false;
            },

            isCollided() {
                const snakeHead = this.snake[0];
                for (let i = 1; i < this.snakeLength; i++) {
                    if (
                        snakeHead.x === this.snake[i].x &&
                        snakeHead.y === this.snake[i].y
                    ) {
                        return 1;
                    }
                }
                if (
                    snakeHead.x >= this.gameBoardSize.width * this.snakeWidth ||
                    snakeHead.y >= this.gameBoardSize.height * this.snakeWidth ||
                    snakeHead.x < 0 ||
                    snakeHead.y < 0
                ) {
                    return 2;
                }
                return 0;
            },

            handleSnakeControl() {
                this.commandsListUpdate();
                if (this.commandsListLength) {
                    this.currentDirection = this.commandsList.shift();
                    this.commandsListLength--;
                }
            },

            commandsListUpdate() {
                document.addEventListener("keydown", (event) => {
                    switch (event.key) {
                        case "ArrowUp":
                        case "w":
                            if (
                                (this.commandsListLength &&
                                    this.commandsList[this.commandsListLength - 1] !== "down" &&
                                    this.commandsList[this.commandsListLength - 1] !== "up") ||
                                (!this.commandsListLength &&
                                    this.currentDirection !== "down" &&
                                    this.currentDirection !== "up")
                            ) {
                                this.commandsList.push("up");
                                this.commandsListLength++;
                            }
                            break;
                        case "ArrowRight":
                        case "d":
                            if (
                                (this.commandsListLength &&
                                    this.commandsList[this.commandsListLength - 1] !== "left" &&
                                    this.commandsList[this.commandsListLength - 1] !==
                                    "right") ||
                                (!this.commandsListLength &&
                                    this.currentDirection !== "left" &&
                                    this.currentDirection !== "right")
                            ) {
                                this.commandsList.push("right");
                                this.commandsListLength++;
                            }
                            break;
                        case "ArrowDown":
                        case "s":
                            if (
                                (this.commandsListLength &&
                                    this.commandsList[this.commandsListLength - 1] !== "down" &&
                                    this.commandsList[this.commandsListLength - 1] !== "up") ||
                                (!this.commandsListLength &&
                                    this.currentDirection !== "down" &&
                                    this.currentDirection !== "up")
                            ) {
                                this.commandsList.push("down");
                                this.commandsListLength++;
                            }
                            break;
                        case "ArrowLeft":
                        case "a":
                            if (
                                (this.commandsListLength &&
                                    this.commandsList[this.commandsListLength - 1] !== "left" &&
                                    this.commandsList[this.commandsListLength - 1] !==
                                    "right") ||
                                (!this.commandsListLength &&
                                    this.currentDirection !== "left" &&
                                    this.currentDirection !== "right")
                            ) {
                                this.commandsList.push("left");
                                this.commandsListLength++;
                            }
                            break;
                    }
                });
            },

            end() {
                console.log("lose");
            },
        };

        game.start();
    </script>
</body>

</html>